{% extends "base.html" %}
{% load humanize %}

{% block title %}ì£¼ë¬¸ ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    /* ì œì‘ì¤‘ ìƒíƒœ ë±ƒì§€ í˜¸ë²„ íš¨ê³¼ */
    a.badge.bg-primary:hover {
        background-color: #0b5ed7 !important;
        transform: scale(1.05);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.4);
    }
    
    a.badge.bg-primary {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    /* ì œí’ˆ ëª©ë¡ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .product-dropdown-wrapper {
        position: relative;
    }
    
    .product-dropdown-btn {
        background-color: #6c757d;
        border: none;
        color: white;
        padding: 6px 12px 6px 28px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        transition: background-color 0.2s ease;
        position: relative;
    }
    
    .product-dropdown-btn:hover {
        background-color: #5a6268;
    }
    
    .product-dropdown-btn::before {
        content: 'âœ“';
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
    }
    
    .product-dropdown-btn::after {
        content: 'â–¼';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        transition: transform 0.2s ease;
    }
    
    .product-dropdown-btn.active::after {
        transform: translateY(-50%) rotate(180deg);
    }
    
    .product-dropdown-btn.active {
        opacity: 0;
        pointer-events: none;
    }
    
    .product-dropdown-menu {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        background-color: #6c757d;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        min-width: 250px;
        max-width: 350px;
    }
    
    .product-dropdown-menu.show {
        display: block;
    }
    
    .product-item {
        color: white;
        padding: 8px 12px;
        font-size: 13px;
        line-height: 1.5;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: default;
    }
    
    .product-item:last-child {
        border-bottom: none;
        border-radius: 0 0 6px 6px;
    }
    
    .product-item:first-child {
        border-radius: 6px 6px 0 0;
    }
    
    .product-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* í…Œì´ë¸” ì˜¤ë²„í”Œë¡œìš° ìˆ˜ì • */
    table tbody,
    table tr {
        overflow: visible !important;
    }
    
    td {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ì£¼ë¬¸ ê´€ë¦¬</h1>
        <div class="d-flex gap-2">
            {% if status_filter == 'NEW' %}
            <a href="{% url 'manual_order_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> ìˆ˜ë™ ë“±ë¡
            </a>
            {% endif %}
            {% if status_filter == 'PRODUCED' %}
            <button type="submit" form="orderListForm" class="btn btn-success" id="exportBtn" disabled>
                <i class="fas fa-file-excel"></i> ì„ íƒ í•­ëª© ì—‘ì…€ ì¶œë ¥ ë° ì™„ë£Œ ì²˜ë¦¬
            </button>
            {% endif %}
        </div>
    </div>

    <!-- ì£¼ë¬¸ íƒ€ì… ì•ˆë‚´ -->
    <div class="alert alert-info mb-3" role="alert">
        <i class="fas fa-info-circle"></i> 
        <strong>ì£¼ë¬¸ íƒ€ì…:</strong>
        <span class="badge bg-light text-dark ms-2"><i class="fas fa-tshirt"></i> ì¼ë°˜</span> = ê¸°ì„±í’ˆ ì£¼ë¬¸ (ì¦‰ì‹œ ë°œì†¡ ì¤€ë¹„)
        <span class="badge bg-light text-dark ms-2"><i class="fas fa-palette"></i> êµ¿ì¦ˆ</span> = ë§ì¶¤ ì œì‘ ì£¼ë¬¸ (ìƒë‹´ â†’ ì‹œì•ˆ â†’ ì œì‘ ë‹¨ê³„ ì§„í–‰)
    </div>

    <!-- ìƒíƒœ í•„í„° -->
    <div class="mb-3">
        <a href="{% url 'order_list' %}" class="btn {% if not status_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">ì „ì²´</a>
        {% for status_value, status_label in status_choices %}
            <a href="{% url 'order_list' %}?status={{ status_value }}" class="btn {% if status_filter == status_value %}btn-primary{% else %}btn-outline-primary{% endif %}">{{ status_label }}</a>
        {% endfor %}
    </div>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% if orders %}
    <form method="post" action="{% url 'export_shipping_excel' %}" id="orderListForm">
        {% csrf_token %}
        <div class="table-responsive" style="overflow: visible;">
            <table class="table table-striped table-hover" style="overflow: visible;">
            <thead>
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <th>
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    {% endif %}
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ìƒíƒœ</th>
                    <th>ê³ ê°ëª…</th>
                    <th>ì£¼ë¬¸ ì œí’ˆ</th>
                    <th>ì´ê¸ˆì•¡</th>
                    <th>ê²°ì œì¼</th>
                    <th>ë§ˆê°ì¼</th>
                    <th>ì•¡ì…˜</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <td>
                        <input type="checkbox" name="order_ids" value="{{ order.id }}" class="form-check-input order-checkbox">
                    </td>
                    {% endif %}
                    <td>
                        <a href="{% url 'order_detail' order.pk %}" class="text-decoration-none fw-bold">
                            {{ order.smartstore_order_id }}
                        </a>
                    </td>
                    <td>
                        {% if order.status == 'PRODUCING' and order.google_drive_folder_url and 'http' in order.google_drive_folder_url %}
                            <a href="{{ order.google_drive_folder_url }}" target="_blank" class="badge bg-primary text-decoration-none" title="í´ë¦­í•˜ì—¬ ì‹œì•ˆ í´ë” ì—´ê¸°">
                                <i class="fas fa-folder-open"></i> {{ order.get_status_display }}
                            </a>
                        {% else %}
                            <span class="badge 
                                {% if order.status == 'NEW' %}bg-warning
                                {% elif order.status == 'CONSULTING' %}bg-info
                                {% elif order.status == 'PRODUCING' %}bg-primary
                                {% elif order.status == 'PRODUCED' %}bg-success
                                {% elif order.status == 'COMPLETED' %}bg-secondary
                                {% elif order.status == 'CANCELED' %}bg-danger
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        {% endif %}
                        {% if order.is_general_order %}
                            <span class="badge bg-light text-dark" title="ì¼ë°˜ ì£¼ë¬¸ (ìƒë‹´/ì œì‘ ë‹¨ê³„ ìƒëµ)">
                                <i class="fas fa-tshirt"></i> ì¼ë°˜
                            </span>
                        {% else %}
                            <span class="badge bg-light text-dark" title="êµ¿ì¦ˆ ì£¼ë¬¸ (ìƒë‹´/ì‹œì•ˆ ì œì‘ í•„ìš”)">
                                <i class="fas fa-palette"></i> êµ¿ì¦ˆ
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ order.customer_name }}</td>
                    <td>
                        {% if order.items.count > 0 %}
                            {% with first_item=order.items.first %}
                            <div class="product-dropdown-wrapper">
                                <button type="button" class="product-dropdown-btn" data-order-id="{{ order.id }}">
                                    <span class="btn-text">{{ first_item.smartstore_product_name }}{% if order.items.count > 1 %} ì™¸ {{ order.items.count|add:"-1" }}{% endif %}</span>
                                </button>
                                <div class="product-dropdown-menu" id="product-menu-{{ order.id }}">
                                    {% for item in order.items.all %}
                                        <div class="product-item">
                                            {{ item.smartstore_product_name }}{% if item.smartstore_option_text %} ({{ item.smartstore_option_text }}){% endif %} x{{ item.quantity }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endwith %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ order.total_order_amount|floatformat:0|intcomma }}ì›</td>
                    <td>{{ order.payment_date|date:"Y-m-d H:i" }}</td>
                    <td>{{ order.due_date|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <!-- ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ -->
                        {% if order.status == 'NEW' %}
                            {% if order.is_general_order %}
                                <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="PRODUCED"
                                        title="ì¼ë°˜ ì£¼ë¬¸: ì œì‘ ì™„ë£Œ ìƒíƒœë¡œ ì¦‰ì‹œ ì´ë™">
                                    <i class="fas fa-forward"></i> ì œì‘ ì™„ë£Œ ì²˜ë¦¬
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-info status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="CONSULTING"
                                        title="êµ¿ì¦ˆ ì£¼ë¬¸: ìƒë‹´/ì‹œì•ˆ ì œì‘ ë‹¨ê³„ ì‹œì‘">
                                    <i class="fas fa-comments"></i> ìƒë‹´ ì‹œì‘
                                </button>
                            {% endif %}
                        {% elif order.status == 'CONSULTING' %}
                            <button type="button" class="btn btn-sm btn-warning upload-design-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-upload"></i> ì‹œì•ˆ ì—…ë¡œë“œ
                            </button>
                        {% elif order.status == 'PRODUCING' %}
                            <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-next-status="PRODUCED">
                                ì œì‘ ì™„ë£Œ
                            </button>
                        {% elif order.status == 'PRODUCED' %}
                            <span class="text-muted">ë°œì†¡ ëŒ€ê¸°</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </form>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">ì´ì „</a>
                </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">ë‹¤ìŒ</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <h3>í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-muted">ë‹¤ë¥¸ ìƒíƒœë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.</p>
    </div>
    {% endif %}
</div>

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì „ì—­)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì „ì²´ ì„ íƒ/í•´ì œ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateExportButton();
        });
    }

    // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateExportButton();
            updateSelectAll();
        });
    });

    function updateExportButton() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.disabled = checkedBoxes.length === 0;
        }
    }

    function updateSelectAll() {
        const allCheckboxes = document.querySelectorAll('.order-checkbox');
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allCheckboxes.length === checkedBoxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        }
    }
});

// ì—‘ì…€ ì¶œë ¥ í›„ ì™„ë£Œëœ ì£¼ë¬¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkedBoxes.length > 0) {
                // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í›„ ì™„ë£Œëœ ì£¼ë¬¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
                setTimeout(function() {
                    window.location.href = '{% url "order_list" %}?status=COMPLETED';
                }, 2000);
            }
        });
    }
});

// ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.status-change-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const orderId = this.getAttribute('data-order-id');
            const nextStatus = this.getAttribute('data-next-status');
            
            console.log('ìƒíƒœ ë³€ê²½ ë²„íŠ¼ í´ë¦­:', orderId, nextStatus);
            
            if (!orderId || !nextStatus) {
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // form ìƒì„± ë° ì œì¶œ
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "change_order_status" %}';
            
            // CSRF í† í°
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);
            
            // order_id
            const orderIdInput = document.createElement('input');
            orderIdInput.type = 'hidden';
            orderIdInput.name = 'order_id';
            orderIdInput.value = orderId;
            form.appendChild(orderIdInput);
            
            // next_status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'next_status';
            statusInput.value = nextStatus;
            form.appendChild(statusInput);
            
            // formì„ bodyì— ì¶”ê°€í•˜ê³  ì œì¶œ
            document.body.appendChild(form);
            form.submit();
        });
    });
});

// ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì´ˆê¸°í™” ì‹œì‘ ===');
    
    // ì‹œì•ˆ ì—…ë¡œë“œ ë²„íŠ¼ë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.upload-design-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨ ===');
            console.log('í´ë¦­ëœ ë²„íŠ¼:', this);
            
            const orderId = this.getAttribute('data-order-id');
            const customerName = this.getAttribute('data-customer-name');
            
            console.log('ì£¼ë¬¸ ID:', orderId);
            console.log('ê³ ê°ëª…:', customerName);
            
            if (!orderId || !customerName) {
                console.error('ì£¼ë¬¸ ID ë˜ëŠ” ê³ ê°ëª…ì´ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ í‘œì‹œ
            showUploadModal(orderId, customerName);
        });
    });
    
    // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function showUploadModal(orderId, customerName) {
        console.log('ëª¨ë‹¬ í‘œì‹œ ì‹œì‘');
        
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
        const existingModal = document.getElementById('uploadDesignModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHTML = `
            <div class="modal fade show" id="uploadDesignModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ì‹œì•ˆ ì—…ë¡œë“œ: ${customerName}</h5>
                            <button type="button" class="btn-close" onclick="closeUploadModal()"></button>
                        </div>
                        <form method="post" action="/orders/upload-design/" enctype="multipart/form-data">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customer_name_display" class="form-label">ê³ ê°ëª…</label>
                                    <input type="text" class="form-control" id="customer_name_display" value="${customerName}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="thumbnail_images" class="form-label">
                                        <i class="fas fa-images me-2"></i>ì¸ë„¤ì¼ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥) <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="thumbnail_images" name="thumbnail_images" multiple required accept="image/jpeg,image/png,image/jpg,image/gif,image/webp">
                                    <div class="form-text">
                                        ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¢Œìš°ë¡œ ë„˜ê²¨ë³¼ ìˆ˜ ìˆëŠ” ì¸ë„¤ì¼ (JPG, PNG, GIF, WEBP) - ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥
                                    </div>
                                    <div id="thumbnail-preview" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="design_files" class="form-label">
                                        <i class="fas fa-upload me-2"></i>ì‹œì•ˆ íŒŒì¼ (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)
                                    </label>
                                    <input type="file" class="form-control" id="design_files" name="design_files" multiple required accept="image/*,.pdf,.ai,.psd">
                                    <div class="form-text">
                                        <div class="alert alert-info py-2 px-3 mt-2 mb-0">
                                            <strong>ğŸ“ íŒŒì¼ ì„ íƒ ë°©ë²•:</strong><br>
                                            â€¢ <strong>Windows:</strong> Ctrl + í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ<br>
                                            â€¢ <strong>Mac:</strong> Cmd (âŒ˜) + í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ<br>
                                            â€¢ <strong>ë²”ìœ„ ì„ íƒ:</strong> Shift + í´ë¦­<br>
                                            <hr class="my-2">
                                            <strong>ğŸ“„ ì§€ì› í˜•ì‹:</strong> JPG, PNG, GIF, PDF, AI, PSD
                                        </div>
                                    </div>
                                    <div id="file-list" class="mt-2"></div>
                                </div>
                                <input type="hidden" name="order_id" value="${orderId}">
                                <!-- ì—…ë¡œë“œ ì§„í–‰ ì¤‘ í‘œì‹œ ì˜ì—­ -->
                                <div id="upload-progress" class="alert alert-warning" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-3" role="status">
                                            <span class="visually-hidden">ì—…ë¡œë“œ ì¤‘...</span>
                                        </div>
                                        <div>
                                            <strong>íŒŒì¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</strong><br>
                                            <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()" id="cancelBtn">ì·¨ì†Œ</button>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">
                                    <i class="fas fa-upload me-2"></i>ì—…ë¡œë“œ ë° ì»¨íŒ ì™„ë£Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.classList.add('modal-open');
        
        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª¨ë‹¬ì´ ì¶”ê°€ëœ í›„)
        setTimeout(() => {
            const fileInput = document.getElementById('design_files');
            const fileList = document.getElementById('file-list');
            const thumbnailInput = document.getElementById('thumbnail_image');
            const thumbnailPreview = document.getElementById('thumbnail-preview');
            const uploadForm = document.querySelector('#uploadDesignModal form');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì—¬ëŸ¬ ì¥)
            if (thumbnailInput && thumbnailPreview) {
                thumbnailInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        let html = `
                            <div class="alert alert-success py-2 px-3">
                                <strong>ì„ íƒëœ ì¸ë„¤ì¼ (${this.files.length}ì¥):</strong>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                        `;
                        
                        Array.from(this.files).forEach((file, idx) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgHtml = `
                                    <div class="text-center">
                                        <img src="${e.target.result}" alt="ì¸ë„¤ì¼ ${idx + 1}" style="max-width: 150px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                        <div class="small mt-1">${idx + 1}. ${file.name}</div>
                                    </div>
                                `;
                                thumbnailPreview.querySelector('.d-flex').insertAdjacentHTML('beforeend', imgHtml);
                            };
                            reader.readAsDataURL(file);
                        });
                        
                        html += '</div></div>';
                        thumbnailPreview.innerHTML = html;
                    } else {
                        thumbnailPreview.innerHTML = '';
                    }
                });
            }
            
            if (fileInput && fileList) {
                fileInput.addEventListener('change', function(e) {
                    if (this.files.length > 0) {
                        let html = '<div class="alert alert-success py-2 px-3"><strong>ì„ íƒëœ íŒŒì¼ (' + this.files.length + 'ê°œ):</strong><ul class="mb-0 mt-1">';
                        for (let i = 0; i < this.files.length; i++) {
                            const file = this.files[i];
                            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                            html += '<li>' + file.name + ' (' + sizeInMB + ' MB)</li>';
                        }
                        html += '</ul></div>';
                        fileList.innerHTML = html;
                    } else {
                        fileList.innerHTML = '';
                    }
                });
            }
            
            // form submit ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    // ë¡œë”© í‘œì‹œ
                    uploadProgress.style.display = 'block';
                    
                    // ë²„íŠ¼ ë¹„í™œì„±í™”
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>ì—…ë¡œë“œ ì¤‘...';
                    
                    // ì·¨ì†Œ ë²„íŠ¼ë„ ë¹„í™œì„±í™”
                    cancelBtn.disabled = true;
                    
                    // formì€ ì •ìƒì ìœ¼ë¡œ ì œì¶œë¨ (e.preventDefault() í•˜ì§€ ì•ŠìŒ)
                });
            }
        }, 100);
        
        console.log('ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
    }
    
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    window.closeUploadModal = function() {
        console.log('ëª¨ë‹¬ ë‹«ê¸°');
        const modal = document.getElementById('uploadDesignModal');
        if (modal) {
            modal.remove();
        }
        document.body.classList.remove('modal-open');
    };
    
    console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì´ˆê¸°í™” ì™„ë£Œ ===');
});

// ì œí’ˆ ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const dropdownButtons = document.querySelectorAll('.product-dropdown-btn');
    
    dropdownButtons.forEach(button => {
        const orderId = button.getAttribute('data-order-id');
        const menu = document.getElementById('product-menu-' + orderId);
        const btnText = button.querySelector('.btn-text');
        const originalText = btnText.textContent;
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // ëª¨ë“  ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('.product-dropdown-menu').forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(b => {
                if (b !== button) {
                    b.classList.remove('active');
                    const otherText = b.querySelector('.btn-text');
                    const otherOriginal = otherText.getAttribute('data-original');
                    if (otherOriginal) {
                        otherText.textContent = otherOriginal;
                    }
                }
            });
            
            // í˜„ì¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                // ë‹«ê¸°
                menu.classList.remove('show');
                button.classList.remove('active');
                btnText.textContent = originalText;
            } else {
                // ì—´ê¸°
                menu.classList.add('show');
                button.classList.add('active');
                btnText.setAttribute('data-original', originalText);
                // ë²„íŠ¼ì€ ìˆ¨ê²¨ì§€ë¯€ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½ ë¶ˆí•„ìš”
            }
        });
    });
    
    // ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.product-dropdown-wrapper')) {
            document.querySelectorAll('.product-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(button => {
                button.classList.remove('active');
                const btnText = button.querySelector('.btn-text');
                const originalText = btnText.getAttribute('data-original');
                if (originalText) {
                    btnText.textContent = originalText;
                }
            });
        }
    });
});
</script>
{% endblock %}
