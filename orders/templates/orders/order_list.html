{% extends "base.html" %}
{% load humanize %}

{% block title %}주문 관리{% endblock %}

{% block extra_css %}
<style>
    /* 제작중 상태 뱃지 호버 효과 */
    a.badge.bg-primary:hover {
        background-color: #0b5ed7 !important;
        transform: scale(1.05);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.4);
    }
    
    a.badge.bg-primary {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    /* 제품 목록 드롭다운 스타일 */
    .product-dropdown-wrapper {
        position: relative;
    }
    
    .product-dropdown-btn {
        background-color: #6c757d;
        border: none;
        color: white;
        padding: 6px 12px 6px 28px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        transition: background-color 0.2s ease;
        position: relative;
    }
    
    .product-dropdown-btn:hover {
        background-color: #5a6268;
    }
    
    .product-dropdown-btn::before {
        content: '✓';
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
    }
    
    .product-dropdown-btn::after {
        content: '▼';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        transition: transform 0.2s ease;
    }
    
    .product-dropdown-btn.active::after {
        transform: translateY(-50%) rotate(180deg);
    }
    
    .product-dropdown-btn.active {
        opacity: 0;
        pointer-events: none;
    }
    
    .product-dropdown-menu {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        background-color: #6c757d;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        min-width: 250px;
        max-width: 350px;
    }
    
    .product-dropdown-menu.show {
        display: block;
    }
    
    .product-item {
        color: white;
        padding: 8px 12px;
        font-size: 13px;
        line-height: 1.5;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: default;
    }
    
    .product-item:last-child {
        border-bottom: none;
        border-radius: 0 0 6px 6px;
    }
    
    .product-item:first-child {
        border-radius: 6px 6px 0 0;
    }
    
    .product-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* 테이블 오버플로우 수정 */
    table tbody,
    table tr {
        overflow: visible !important;
    }
    
    td {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>주문 관리</h1>
        <div class="d-flex gap-2">
            {% if status_filter == 'NEW' %}
            <a href="{% url 'manual_order_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> 수동 등록
            </a>
            {% endif %}
            {% if status_filter == 'PRODUCED' %}
            <button type="submit" form="orderListForm" class="btn btn-success" id="exportBtn" disabled>
                <i class="fas fa-file-excel"></i> 선택 항목 엑셀 출력 및 완료 처리
            </button>
            {% endif %}
        </div>
    </div>

    <!-- 주문 타입 안내 -->
    <div class="alert alert-info mb-3" role="alert">
        <i class="fas fa-info-circle"></i> 
        <strong>주문 타입:</strong>
        <span class="badge bg-light text-dark ms-2"><i class="fas fa-tshirt"></i> 일반</span> = 기성품 주문 (즉시 발송 준비)
        <span class="badge bg-light text-dark ms-2"><i class="fas fa-palette"></i> 굿즈</span> = 맞춤 제작 주문 (상담 → 시안 → 제작 단계 진행)
    </div>

    <!-- 상태 필터 -->
    <div class="mb-3">
        <a href="{% url 'order_list' %}" class="btn {% if not status_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">전체</a>
        {% for status_value, status_label in status_choices %}
            <a href="{% url 'order_list' %}?status={{ status_value }}" class="btn {% if status_filter == status_value %}btn-primary{% else %}btn-outline-primary{% endif %}">{{ status_label }}</a>
        {% endfor %}
    </div>

    <!-- 메시지 표시 -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% if orders %}
    <form method="post" action="{% url 'export_shipping_excel' %}" id="orderListForm">
        {% csrf_token %}
        <div class="table-responsive" style="overflow: visible;">
            <table class="table table-striped table-hover" style="overflow: visible;">
            <thead>
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <th>
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    {% endif %}
                    <th>주문번호</th>
                    <th>상태</th>
                    <th>고객명</th>
                    <th>인쇄방법</th>
                    <th>주문 제품</th>
                    <th>총금액</th>
                    <th>결제일</th>
                    <th>마감일</th>
                    <th>액션</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <td>
                        <input type="checkbox" name="order_ids" value="{{ order.id }}" class="form-check-input order-checkbox">
                    </td>
                    {% endif %}
                    <td>
                        <a href="{% url 'order_detail' order.pk %}" class="text-decoration-none fw-bold">
                            {{ order.smartstore_order_id }}
                        </a>
                    </td>
                    <td>
                        {% if order.status == 'PRODUCING' and order.google_drive_folder_url and 'http' in order.google_drive_folder_url %}
                            <a href="{{ order.google_drive_folder_url }}" target="_blank" class="badge bg-primary text-decoration-none" title="클릭하여 시안 폴더 열기">
                                <i class="fas fa-folder-open"></i> {{ order.get_status_display }}
                            </a>
                        {% else %}
                            <span class="badge 
                                {% if order.status == 'NEW' %}bg-warning
                                {% elif order.status == 'CONSULTING' %}bg-info
                                {% elif order.status == 'PRODUCING' %}bg-primary
                                {% elif order.status == 'PRODUCED' %}bg-success
                                {% elif order.status == 'COMPLETED' %}bg-secondary
                                {% elif order.status == 'SETTLED' %}bg-dark
                                {% elif order.status == 'CANCELED' %}bg-danger
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        {% endif %}
                        {% if order.is_general_order %}
                            <span class="badge bg-light text-dark" title="일반 주문 (상담/제작 단계 생략)">
                                <i class="fas fa-tshirt"></i> 일반
                            </span>
                        {% else %}
                            <span class="badge bg-light text-dark" title="굿즈 주문 (상담/시안 제작 필요)">
                                <i class="fas fa-palette"></i> 굿즈
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ order.customer_name }}</td>
                    <td class="text-center">
                        {% if order.print_method %}
                            <span class="badge bg-info">{{ order.get_print_method_display }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.items.count > 0 %}
                            {% with first_item=order.items.first %}
                            <div class="product-dropdown-wrapper">
                                <button type="button" class="product-dropdown-btn" data-order-id="{{ order.id }}">
                                    <span class="btn-text">{{ first_item.smartstore_product_name }}{% if order.items.count > 1 %} 외 {{ order.items.count|add:"-1" }}{% endif %}</span>
                                </button>
                                <div class="product-dropdown-menu" id="product-menu-{{ order.id }}">
                                    {% for item in order.items.all %}
                                        <div class="product-item">
                                            {{ item.smartstore_product_name }}{% if item.smartstore_option_text %} ({{ item.smartstore_option_text }}){% endif %} x{{ item.quantity }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endwith %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ order.total_order_amount|floatformat:0|intcomma }}원</td>
                    <td>{{ order.payment_date|date:"Y-m-d H:i" }}</td>
                    <td>{{ order.due_date|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <!-- 상태별 액션 버튼 -->
                        {% if order.status == 'NEW' %}
                            {% if order.is_general_order %}
                                <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="PRODUCED"
                                        title="일반 주문: 제작 완료 상태로 즉시 이동">
                                    <i class="fas fa-forward"></i> 제작 완료 처리
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-info status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="CONSULTING"
                                        title="굿즈 주문: 상담/시안 제작 단계 시작">
                                    <i class="fas fa-comments"></i> 상담 시작
                                </button>
                            {% endif %}
                        {% elif order.status == 'CONSULTING' %}
                            <button type="button" class="btn btn-sm btn-warning upload-design-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-upload"></i> 시안 업로드
                            </button>
                        {% elif order.status == 'PRODUCING' %}
                            <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-next-status="PRODUCED">
                                제작 완료
                            </button>
                        {% elif order.status == 'PRODUCED' %}
                            <span class="text-muted">발송 대기</span>
                        {% elif order.status == 'COMPLETED' %}
                            <button type="button" class="btn btn-sm btn-success completion-input-btn-list" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-clipboard-check"></i> 결과 입력
                            </button>
                        {% elif order.status == 'SETTLED' %}
                            <button type="button" class="btn btn-sm btn-dark view-completion-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-eye"></i> 보기
                            </button>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </form>

    <!-- 페이지네이션 -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">이전</a>
                </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">다음</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <h3>해당하는 주문이 없습니다</h3>
        <p class="text-muted">다른 상태를 선택해보세요.</p>
    </div>
    {% endif %}
</div>

<script>
// CSRF 토큰 가져오기 함수 (전역)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 전체 선택/해제 기능
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateExportButton();
        });
    }

    // 개별 체크박스 변경 시
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateExportButton();
            updateSelectAll();
        });
    });

    function updateExportButton() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.disabled = checkedBoxes.length === 0;
        }
    }

    function updateSelectAll() {
        const allCheckboxes = document.querySelectorAll('.order-checkbox');
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allCheckboxes.length === checkedBoxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        }
    }
});

// 엑셀 출력 후 완료된 주문 목록으로 이동
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkedBoxes.length > 0) {
                // 엑셀 다운로드 후 완료된 주문 목록으로 이동
                setTimeout(function() {
                    window.location.href = '{% url "order_list" %}?status=COMPLETED';
                }, 2000);
            }
        });
    }
});

// 상태 변경 버튼 처리
document.addEventListener('DOMContentLoaded', function() {
    // 상태 변경 버튼에 클릭 이벤트 추가
    document.querySelectorAll('.status-change-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const orderId = this.getAttribute('data-order-id');
            const nextStatus = this.getAttribute('data-next-status');
            
            console.log('상태 변경 버튼 클릭:', orderId, nextStatus);
            
            if (!orderId || !nextStatus) {
                alert('주문 정보를 찾을 수 없습니다.');
                return;
            }
            
            // form 생성 및 제출
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "change_order_status" %}';
            
            // CSRF 토큰
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);
            
            // order_id
            const orderIdInput = document.createElement('input');
            orderIdInput.type = 'hidden';
            orderIdInput.name = 'order_id';
            orderIdInput.value = orderId;
            form.appendChild(orderIdInput);
            
            // next_status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'next_status';
            statusInput.value = nextStatus;
            form.appendChild(statusInput);
            
            // form을 body에 추가하고 제출
            document.body.appendChild(form);
            form.submit();
        });
    });
});

// 시안 업로드 모달 처리
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== 시안 업로드 모달 초기화 시작 ===');
    
    // 시안 업로드 버튼들에 클릭 이벤트 추가
    document.querySelectorAll('.upload-design-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('=== 시안 업로드 버튼 클릭됨 ===');
            console.log('클릭된 버튼:', this);
            
            const orderId = this.getAttribute('data-order-id');
            const customerName = this.getAttribute('data-customer-name');
            
            console.log('주문 ID:', orderId);
            console.log('고객명:', customerName);
            
            if (!orderId || !customerName) {
                console.error('주문 ID 또는 고객명이 없습니다!');
                alert('주문 정보를 찾을 수 없습니다.');
                return;
            }
            
            // 모달 표시
            showUploadModal(orderId, customerName);
        });
    });
    
    // 모달 표시 함수
    function showUploadModal(orderId, customerName) {
        console.log('모달 표시 시작');
        
        // 기존 모달이 있으면 제거
        const existingModal = document.getElementById('uploadDesignModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 모달 HTML 생성
        const modalHTML = `
            <div class="modal fade show" id="uploadDesignModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">시안 업로드: ${customerName}</h5>
                            <button type="button" class="btn-close" onclick="closeUploadModal()"></button>
                        </div>
                        <form method="post" action="/orders/upload-design/" enctype="multipart/form-data">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customer_name_display" class="form-label">고객명</label>
                                    <input type="text" class="form-control" id="customer_name_display" value="${customerName}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="thumbnail_images" class="form-label">
                                        <i class="fas fa-images me-2"></i>썸네일 이미지 (여러 장 선택 가능) <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="thumbnail_images" name="thumbnail_images" multiple required accept="image/jpeg,image/png,image/jpg,image/gif,image/webp">
                                    <div class="form-text">
                                        주문 상세 페이지에서 좌우로 넘겨볼 수 있는 썸네일 (JPG, PNG, GIF, WEBP) - 여러 장 선택 가능
                                    </div>
                                    <div id="thumbnail-preview" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="design_files" class="form-label">
                                        <i class="fas fa-upload me-2"></i>시안 파일 (여러 파일 선택 가능)
                                    </label>
                                    <input type="file" class="form-control" id="design_files" name="design_files" multiple required accept="image/*,.pdf,.ai,.psd">
                                    <div class="form-text">
                                        <div class="alert alert-info py-2 px-3 mt-2 mb-0">
                                            <strong>📁 파일 선택 방법:</strong><br>
                                            • <strong>Windows:</strong> Ctrl + 클릭으로 여러 파일 선택<br>
                                            • <strong>Mac:</strong> Cmd (⌘) + 클릭으로 여러 파일 선택<br>
                                            • <strong>범위 선택:</strong> Shift + 클릭<br>
                                            <hr class="my-2">
                                            <strong>📄 지원 형식:</strong> JPG, PNG, GIF, PDF, AI, PSD
                                        </div>
                                    </div>
                                    <div id="file-list" class="mt-2"></div>
                                </div>
                                <input type="hidden" name="order_id" value="${orderId}">
                                <!-- 업로드 진행 중 표시 영역 -->
                                <div id="upload-progress" class="alert alert-warning" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-3" role="status">
                                            <span class="visually-hidden">업로드 중...</span>
                                        </div>
                                        <div>
                                            <strong>파일 업로드 중입니다...</strong><br>
                                            <small class="text-muted">잠시만 기다려주세요. 창을 닫지 마세요.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()" id="cancelBtn">취소</button>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">
                                    <i class="fas fa-upload me-2"></i>업로드 및 컨펌 완료
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        // 모달을 body에 추가
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.classList.add('modal-open');
        
        // 파일 선택 이벤트 리스너 추가 (모달이 추가된 후)
        setTimeout(() => {
            const fileInput = document.getElementById('design_files');
            const fileList = document.getElementById('file-list');
            const thumbnailInput = document.getElementById('thumbnail_image');
            const thumbnailPreview = document.getElementById('thumbnail-preview');
            const uploadForm = document.querySelector('#uploadDesignModal form');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // 썸네일 이미지 미리보기 (여러 장)
            if (thumbnailInput && thumbnailPreview) {
                thumbnailInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        let html = `
                            <div class="alert alert-success py-2 px-3">
                                <strong>선택된 썸네일 (${this.files.length}장):</strong>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                        `;
                        
                        Array.from(this.files).forEach((file, idx) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgHtml = `
                                    <div class="text-center">
                                        <img src="${e.target.result}" alt="썸네일 ${idx + 1}" style="max-width: 150px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                        <div class="small mt-1">${idx + 1}. ${file.name}</div>
                                    </div>
                                `;
                                thumbnailPreview.querySelector('.d-flex').insertAdjacentHTML('beforeend', imgHtml);
                            };
                            reader.readAsDataURL(file);
                        });
                        
                        html += '</div></div>';
                        thumbnailPreview.innerHTML = html;
                    } else {
                        thumbnailPreview.innerHTML = '';
                    }
                });
            }
            
            if (fileInput && fileList) {
                fileInput.addEventListener('change', function(e) {
                    if (this.files.length > 0) {
                        let html = '<div class="alert alert-success py-2 px-3"><strong>선택된 파일 (' + this.files.length + '개):</strong><ul class="mb-0 mt-1">';
                        for (let i = 0; i < this.files.length; i++) {
                            const file = this.files[i];
                            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                            html += '<li>' + file.name + ' (' + sizeInMB + ' MB)</li>';
                        }
                        html += '</ul></div>';
                        fileList.innerHTML = html;
                    } else {
                        fileList.innerHTML = '';
                    }
                });
            }
            
            // form submit 이벤트 처리
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    // 로딩 표시
                    uploadProgress.style.display = 'block';
                    
                    // 버튼 비활성화
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>업로드 중...';
                    
                    // 취소 버튼도 비활성화
                    cancelBtn.disabled = true;
                    
                    // form은 정상적으로 제출됨 (e.preventDefault() 하지 않음)
                });
            }
        }, 100);
        
        console.log('모달 표시 완료');
    }
    
    // 모달 닫기 함수
    window.closeUploadModal = function() {
        console.log('모달 닫기');
        const modal = document.getElementById('uploadDesignModal');
        if (modal) {
            modal.remove();
        }
        document.body.classList.remove('modal-open');
    };
    
    console.log('=== 시안 업로드 모달 초기화 완료 ===');
});

// 제품 드롭다운 기능
document.addEventListener('DOMContentLoaded', function() {
    const dropdownButtons = document.querySelectorAll('.product-dropdown-btn');
    
    dropdownButtons.forEach(button => {
        const orderId = button.getAttribute('data-order-id');
        const menu = document.getElementById('product-menu-' + orderId);
        const btnText = button.querySelector('.btn-text');
        const originalText = btnText.textContent;
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 모든 다른 드롭다운 닫기
            document.querySelectorAll('.product-dropdown-menu').forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(b => {
                if (b !== button) {
                    b.classList.remove('active');
                    const otherText = b.querySelector('.btn-text');
                    const otherOriginal = otherText.getAttribute('data-original');
                    if (otherOriginal) {
                        otherText.textContent = otherOriginal;
                    }
                }
            });
            
            // 현재 드롭다운 토글
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                // 닫기
                menu.classList.remove('show');
                button.classList.remove('active');
                btnText.textContent = originalText;
            } else {
                // 열기
                menu.classList.add('show');
                button.classList.add('active');
                btnText.setAttribute('data-original', originalText);
                // 버튼은 숨겨지므로 텍스트 변경 불필요
            }
        });
    });
    
    // 외부 클릭 시 모든 드롭다운 닫기
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.product-dropdown-wrapper')) {
            document.querySelectorAll('.product-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(button => {
                button.classList.remove('active');
                const btnText = button.querySelector('.btn-text');
                const originalText = btnText.getAttribute('data-original');
                if (originalText) {
                    btnText.textContent = originalText;
                }
            });
        }
    });
});

// 결과 입력 모달 (주문 목록에서)
document.addEventListener('click', function(e) {
    if (e.target.closest('.completion-input-btn-list')) {
        const btn = e.target.closest('.completion-input-btn-list');
        const orderId = btn.dataset.orderId;
        const customerName = btn.dataset.customerName;
        showCompletionModal(orderId, customerName);
    }
    
    // 완료사진 보기 모달
    if (e.target.closest('.view-completion-btn')) {
        const btn = e.target.closest('.view-completion-btn');
        const orderId = btn.dataset.orderId;
        const customerName = btn.dataset.customerName;
        showViewCompletionModal(orderId, customerName);
    }
});

// 완료 결과 입력 모달 표시 함수
function showCompletionModal(orderId, customerName) {
    // 기존 모달이 있으면 제거
    const existingModal = document.getElementById('completionInputModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 모달 HTML 생성
    const modalHTML = `
        <div class="modal fade show" id="completionInputModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-clipboard-check"></i> 결과 입력: ${customerName}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeCompletionModal()"></button>
                    </div>
                    <form method="post" action="/orders/${orderId}/completion/" enctype="multipart/form-data">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="tracking_number" class="form-label">
                                    <i class="fas fa-truck"></i> 송장번호
                                </label>
                                <input type="text" class="form-control" id="tracking_number" name="tracking_number" 
                                       placeholder="송장번호를 입력하세요">
                                <div class="form-text">
                                    택배 송장번호를 입력하세요 (선택사항)
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="completion_photos" class="form-label">
                                    <i class="fas fa-images"></i> 완료사진 (여러 장 선택 가능)
                                </label>
                                <input type="file" class="form-control" id="completion_photos" 
                                       name="completion_photos" multiple accept="image/*">
                                <div class="form-text">
                                    제작 완료된 제품의 사진을 업로드하세요. (JPG, PNG 등)
                                </div>
                                <div id="completion-photo-preview" class="mt-2"></div>
                            </div>
                            
                            <div class="alert alert-info small mb-0">
                                <i class="fas fa-info-circle"></i> 
                                결과 입력이 완료되면 상태가 <strong>정산 목록</strong>으로 변경됩니다.
                            </div>
                            
                            <!-- 업로드 진행 중 표시 영역 -->
                            <div id="completion-upload-progress" class="alert alert-warning mt-3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-3" role="status">
                                        <span class="visually-hidden">업로드 중...</span>
                                    </div>
                                    <div>
                                        <strong>결과 입력 중입니다...</strong><br>
                                        <small class="text-muted">잠시만 기다려주세요. 창을 닫지 마세요.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeCompletionModal()" id="completionCancelBtn">취소</button>
                            <button type="submit" class="btn btn-success" id="completionSubmitBtn">
                                <i class="fas fa-check-double"></i> 결과 저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // 모달을 body에 추가
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
    
    // 파일 선택 이벤트 리스너 추가
    setTimeout(() => {
        const photoInput = document.getElementById('completion_photos');
        const photoPreview = document.getElementById('completion-photo-preview');
        const completionForm = document.querySelector('#completionInputModal form');
        const uploadProgress = document.getElementById('completion-upload-progress');
        const submitBtn = document.getElementById('completionSubmitBtn');
        const cancelBtn = document.getElementById('completionCancelBtn');
        
        // 완료사진 미리보기
        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function(e) {
                if (this.files && this.files.length > 0) {
                    let html = `
                        <div class="alert alert-success py-2 px-3">
                            <i class="fas fa-check-circle"></i> 
                            <strong>${this.files.length}장의 사진</strong>이 선택되었습니다.
                        </div>
                    `;
                    photoPreview.innerHTML = html;
                } else {
                    photoPreview.innerHTML = '';
                }
            });
        }
        
        // 폼 제출 시 진행 표시
        if (completionForm) {
            completionForm.addEventListener('submit', function(e) {
                uploadProgress.style.display = 'block';
                submitBtn.disabled = true;
                cancelBtn.disabled = true;
            });
        }
    }, 100);
}

// 완료 입력 모달 닫기
function closeCompletionModal() {
    const modal = document.getElementById('completionInputModal');
    if (modal) {
        modal.remove();
    }
    document.body.classList.remove('modal-open');
}

// 완료사진 보기 모달
function showViewCompletionModal(orderId, customerName) {
    // AJAX로 완료사진 정보 가져오기
    fetch(`/orders/${orderId}/completion-info/`)
        .then(response => response.json())
        .then(data => {
            displayViewCompletionModal(data, customerName);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('완료 정보를 가져오는 중 오류가 발생했습니다.');
        });
}

// 완료사진 보기 모달 표시
function displayViewCompletionModal(data, customerName) {
    const existingModal = document.getElementById('viewCompletionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 완료사진 이미지 HTML 생성
    let photosHTML = '';
    if (data.completion_photos && data.completion_photos.length > 0) {
        data.completion_photos.forEach((photo, index) => {
            photosHTML += `
                <div class="carousel-item ${index === 0 ? 'active' : ''}" style="text-align: center; position: relative;">
                    <img src="${photo.image_url}" alt="완료사진 ${index + 1}" style="max-width: 100%; max-height: 500px; object-fit: contain;">
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-primary" onclick="copyImageToClipboard('${photo.image_url}', event)">
                            <i class="fas fa-copy"></i> 이미지 복사
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        photosHTML = '<div class="alert alert-info">완료사진이 없습니다.</div>';
    }
    
    // 송장번호 HTML
    const trackingHTML = data.tracking_number ? `
        <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" id="trackingNumberCopy" value="${data.tracking_number}" readonly>
            <button type="button" class="btn btn-primary" onclick="copyTrackingNumber()">
                <i class="fas fa-copy"></i> 복사
            </button>
        </div>
    ` : '<span class="text-muted">송장번호가 입력되지 않았습니다.</span>';
    
    const modalHTML = `
        <div class="modal fade show" id="viewCompletionModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="fas fa-eye"></i> 결과 보기: ${customerName}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeViewCompletionModal()"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 완료사진 -->
                        <div class="mb-4">
                            <h6 class="mb-3"><i class="fas fa-images"></i> 완료사진</h6>
                            ${data.completion_photos && data.completion_photos.length > 0 ? `
                                <div id="completionPhotoCarousel" class="carousel slide" data-bs-ride="false" style="position: relative;">
                                    <div class="carousel-inner">
                                        ${photosHTML}
                                    </div>
                                    ${data.completion_photos.length > 1 ? `
                                        <button class="carousel-control-prev" type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide="prev" style="position: absolute; top: 50%; transform: translateY(-50%); left: 10px; background-color: rgba(0,0,0,0.5); border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; z-index: 10;">
                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide="next" style="position: absolute; top: 50%; transform: translateY(-50%); right: 10px; background-color: rgba(0,0,0,0.5); border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; z-index: 10;">
                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        </button>
                                        <div class="carousel-indicators" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10;">
                                            ${data.completion_photos.map((_, index) => `
                                                <button type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}" style="background-color: ${index === 0 ? '#0dcaf0' : 'rgba(255,255,255,0.5)'}; padding: 8px 12px; border-radius: 20px; border: none; min-width: 35px; cursor: pointer;"></button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : photosHTML}
                        </div>
                        
                        <hr>
                        
                        <!-- 송장번호 -->
                        <div class="mb-3">
                            <h6 class="mb-3"><i class="fas fa-truck"></i> 송장번호</h6>
                            ${trackingHTML}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeViewCompletionModal()">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
    
    // Bootstrap 캐러셀 초기화
    if (data.completion_photos && data.completion_photos.length > 1) {
        const carouselElement = document.getElementById('completionPhotoCarousel');
        if (carouselElement && window.bootstrap) {
            new bootstrap.Carousel(carouselElement);
        }
    }
}

// 완료사진 보기 모달 닫기
function closeViewCompletionModal() {
    const modal = document.getElementById('viewCompletionModal');
    if (modal) {
        modal.remove();
    }
    document.body.classList.remove('modal-open');
}

// 송장번호 복사
function copyTrackingNumber() {
    const input = document.getElementById('trackingNumberCopy');
    input.select();
    document.execCommand('copy');
    
    // 복사 완료 표시
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> 복사됨';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}

// 이미지를 클립보드에 복사
async function copyImageToClipboard(imageUrl, event) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    
    try {
        // 버튼 상태 변경 (로딩)
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 복사 중...';
        
        // Canvas를 사용하여 이미지 로드
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        // 이미지 로드 완료 대기
        await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = imageUrl;
        });
        
        // Canvas에 이미지 그리기
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        // Canvas를 Blob으로 변환
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // 클립보드에 복사
        await navigator.clipboard.write([
            new ClipboardItem({
                'image/png': blob
            })
        ]);
        
        // 복사 성공 표시
        btn.innerHTML = '<i class="fas fa-check"></i> 복사 완료!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('이미지 복사 실패:', error);
        
        // 복사 실패 표시
        btn.innerHTML = '<i class="fas fa-times"></i> 복사 실패';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
            btn.disabled = false;
        }, 2000);
    }
}

// 이미지 전체화면 모달
function openImageModal(imageUrl) {
    const existingModal = document.getElementById('imageFullscreenModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="imageFullscreenModal" style="position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;" onclick="closeImageModal()">
            <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 50px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeImageModal() {
    const modal = document.getElementById('imageFullscreenModal');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}
