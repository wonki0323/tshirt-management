{% extends "base.html" %}
{% load humanize %}

{% block title %}ì£¼ë¬¸ ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    /* ì œì‘ì¤‘ ìƒíƒœ ë±ƒì§€ í˜¸ë²„ íš¨ê³¼ */
    a.badge.bg-primary:hover {
        background-color: #0b5ed7 !important;
        transform: scale(1.05);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.4);
    }
    
    a.badge.bg-primary {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    /* ì œí’ˆ ëª©ë¡ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .product-dropdown-wrapper {
        position: relative;
    }
    
    .product-dropdown-btn {
        background-color: #6c757d;
        border: none;
        color: white;
        padding: 6px 12px 6px 28px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        transition: background-color 0.2s ease;
        position: relative;
    }
    
    .product-dropdown-btn:hover {
        background-color: #5a6268;
    }
    
    .product-dropdown-btn::before {
        content: 'âœ“';
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: bold;
    }
    
    .product-dropdown-btn::after {
        content: 'â–¼';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        transition: transform 0.2s ease;
    }
    
    .product-dropdown-btn.active::after {
        transform: translateY(-50%) rotate(180deg);
    }
    
    .product-dropdown-btn.active {
        opacity: 0;
        pointer-events: none;
    }
    
    .product-dropdown-menu {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        background-color: #6c757d;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        min-width: 250px;
        max-width: 350px;
    }
    
    .product-dropdown-menu.show {
        display: block;
    }
    
    .product-item {
        color: white;
        padding: 8px 12px;
        font-size: 13px;
        line-height: 1.5;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: default;
    }
    
    .product-item:last-child {
        border-bottom: none;
        border-radius: 0 0 6px 6px;
    }
    
    .product-item:first-child {
        border-radius: 6px 6px 0 0;
    }
    
    .product-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* í…Œì´ë¸” ì˜¤ë²„í”Œë¡œìš° ìˆ˜ì • */
    table tbody,
    table tr {
        overflow: visible !important;
    }
    
    td {
        position: relative;
    }
    
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
    }
    
    .calendar-day {
        background-color: white;
        min-height: 120px;
        padding: 8px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .calendar-day:hover {
        background-color: #f8f9fa;
    }
    
    .calendar-day-header {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
        color: #495057;
    }
    
    .calendar-day.other-month {
        background-color: #f8f9fa;
        opacity: 0.5;
    }
    
    .calendar-day.today {
        background-color: #e7f3ff;
    }
    
    .calendar-header {
        background-color: #f8f9fa;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-bottom: 2px solid #dee2e6;
    }
    
    .calendar-header.sunday {
        color: #dc3545;
    }
    
    .calendar-header.saturday {
        color: #0d6efd;
    }
    
    .calendar-order-item {
        font-size: 11px;
        padding: 3px 6px;
        margin-bottom: 2px;
        border-radius: 3px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: transform 0.2s;
    }
    
    .calendar-order-item:hover {
        transform: scale(1.05);
        z-index: 10;
        position: relative;
    }
    
    .calendar-order-item.pending {
        background-color: #28a745;
        color: white;
    }
    
    .calendar-order-item.shipped {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-group .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" id="orderManagementContainer">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ì£¼ë¬¸ ê´€ë¦¬</h1>
        <div class="d-flex gap-2">
            {% if status_filter == 'NEW' %}
            <a href="{% url 'manual_order_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> ìˆ˜ë™ ë“±ë¡
            </a>
            {% endif %}
            {% if status_filter == 'PRODUCED' %}
            <button type="submit" form="orderListForm" class="btn btn-success" id="exportBtn" disabled>
                <i class="fas fa-file-excel"></i> ì„ íƒ í•­ëª© ì—‘ì…€ ì¶œë ¥ ë° ì™„ë£Œ ì²˜ë¦¬
            </button>
            {% endif %}
        </div>
    </div>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- ğŸ“‹ ë¦¬ìŠ¤íŠ¸ ë·° (ìƒë‹¨) -->
    <div id="listView">
        <h2 class="mb-3">
            <i class="fas fa-list"></i> ì£¼ë¬¸ ëª©ë¡
        </h2>
        <!-- ìƒíƒœ í•„í„° -->
        <div class="mb-3">
            <a href="{% url 'order_list' %}" class="btn {% if not status_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">ì „ì²´</a>
            {% for status_value, status_label in status_choices %}
                <a href="{% url 'order_list' %}?status={{ status_value }}" class="btn {% if status_filter == status_value %}btn-primary{% else %}btn-outline-primary{% endif %}">{{ status_label }}</a>
            {% endfor %}
        </div>

        {% if orders %}
    <form method="post" action="{% url 'export_shipping_excel' %}" id="orderListForm">
        {% csrf_token %}
        <div class="table-responsive" style="overflow: visible;">
            <table class="table table-striped table-hover" style="overflow: visible;">
            <thead>
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <th>
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    {% endif %}
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ìƒíƒœ</th>
                    <th>ê³ ê°ëª…</th>
                    <th>ì¸ì‡„ë°©ë²•</th>
                    <th>ì£¼ë¬¸ ì œí’ˆ</th>
                    <th>ì´ê¸ˆì•¡</th>
                    <th>ê²°ì œì¼</th>
                    <th>ë§ˆê°ì¼</th>
                    <th>ì•¡ì…˜</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    {% if status_filter == 'PRODUCED' %}
                    <td>
                        <input type="checkbox" name="order_ids" value="{{ order.id }}" class="form-check-input order-checkbox">
                    </td>
                    {% endif %}
                    <td>
                        <a href="{% url 'order_detail' order.pk %}" class="text-decoration-none fw-bold">
                            {{ order.smartstore_order_id }}
                        </a>
                    </td>
                    <td>
                        {% if order.status == 'PRODUCING' and order.google_drive_folder_url and 'http' in order.google_drive_folder_url %}
                            <a href="{{ order.google_drive_folder_url }}" target="_blank" class="badge bg-primary text-decoration-none" title="í´ë¦­í•˜ì—¬ ì‹œì•ˆ í´ë” ì—´ê¸°">
                                <i class="fas fa-folder-open"></i> {{ order.get_status_display }}
                            </a>
                        {% else %}
                            <span class="badge 
                                {% if order.status == 'NEW' %}bg-warning
                                {% elif order.status == 'CONSULTING' %}bg-info
                                {% elif order.status == 'PRODUCING' %}bg-primary
                                {% elif order.status == 'PRODUCED' %}bg-success
                                {% elif order.status == 'COMPLETED' %}bg-secondary
                                {% elif order.status == 'SETTLED' %}bg-dark
                                {% elif order.status == 'CANCELED' %}bg-danger
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        {% endif %}
                        {% if order.is_general_order %}
                            <span class="badge bg-light text-dark" title="ì¼ë°˜ ì£¼ë¬¸ (ìƒë‹´/ì œì‘ ë‹¨ê³„ ìƒëµ)">
                                <i class="fas fa-tshirt"></i> ì¼ë°˜
                            </span>
                        {% else %}
                            <span class="badge bg-light text-dark" title="êµ¿ì¦ˆ ì£¼ë¬¸ (ìƒë‹´/ì‹œì•ˆ ì œì‘ í•„ìš”)">
                                <i class="fas fa-palette"></i> êµ¿ì¦ˆ
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ order.customer_name }}</td>
                    <td class="text-center">
                        {% if order.print_method %}
                            <span class="badge bg-info">{{ order.get_print_method_display }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.items.count > 0 %}
                            {% with first_item=order.items.first %}
                            <div class="product-dropdown-wrapper">
                                <button type="button" class="product-dropdown-btn" data-order-id="{{ order.id }}">
                                    <span class="btn-text">{{ first_item.smartstore_product_name }}{% if order.items.count > 1 %} ì™¸ {{ order.items.count|add:"-1" }}{% endif %}</span>
                                </button>
                                <div class="product-dropdown-menu" id="product-menu-{{ order.id }}">
                                    {% for item in order.items.all %}
                                        <div class="product-item">
                                            {{ item.smartstore_product_name }}{% if item.smartstore_option_text %} ({{ item.smartstore_option_text }}){% endif %} x{{ item.quantity }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endwith %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ order.total_order_amount|floatformat:0|intcomma }}ì›</td>
                    <td>{{ order.payment_date|date:"Y-m-d H:i" }}</td>
                    <td>{{ order.due_date|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <!-- ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ -->
                        {% if order.status == 'NEW' %}
                            {% if order.is_general_order %}
                                <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="PRODUCED"
                                        title="ì¼ë°˜ ì£¼ë¬¸: ì œì‘ ì™„ë£Œ ìƒíƒœë¡œ ì¦‰ì‹œ ì´ë™">
                                    <i class="fas fa-forward"></i> ì œì‘ ì™„ë£Œ ì²˜ë¦¬
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-info status-change-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-next-status="CONSULTING"
                                        title="êµ¿ì¦ˆ ì£¼ë¬¸: ìƒë‹´/ì‹œì•ˆ ì œì‘ ë‹¨ê³„ ì‹œì‘">
                                    <i class="fas fa-comments"></i> ìƒë‹´ ì‹œì‘
                                </button>
                            {% endif %}
                        {% elif order.status == 'CONSULTING' %}
                            <button type="button" class="btn btn-sm btn-warning upload-design-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-upload"></i> ì‹œì•ˆ ì—…ë¡œë“œ
                            </button>
                        {% elif order.status == 'PRODUCING' %}
                            <button type="button" class="btn btn-sm btn-success status-change-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-next-status="PRODUCED">
                                ì œì‘ ì™„ë£Œ
                            </button>
                        {% elif order.status == 'PRODUCED' %}
                            <span class="text-muted">ë°œì†¡ ëŒ€ê¸°</span>
                        {% elif order.status == 'COMPLETED' %}
                            <button type="button" class="btn btn-sm btn-success completion-input-btn-list" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-clipboard-check"></i> ê²°ê³¼ ì…ë ¥
                            </button>
                        {% elif order.status == 'SETTLED' %}
                            <button type="button" class="btn btn-sm btn-dark view-completion-btn" 
                                    data-order-id="{{ order.id }}" 
                                    data-customer-name="{{ order.customer_name }}">
                                <i class="fas fa-eye"></i> ë³´ê¸°
                            </button>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </form>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">ì´ì „</a>
                </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">ë‹¤ìŒ</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

        {% else %}
        <div class="text-center py-5">
            <h3>í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-muted">ë‹¤ë¥¸ ìƒíƒœë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.</p>
        </div>
        {% endif %}
    </div>
    <!-- ë¦¬ìŠ¤íŠ¸ ë·° ë -->
    
    <hr class="my-5">
    
    <!-- ğŸ“… ìº˜ë¦°ë” ë·° (í•˜ë‹¨) -->
    <div id="calendarView" class="mb-5">
        <h2 class="mb-3">
            <i class="fas fa-calendar-alt"></i> ì£¼ë¬¸ ìŠ¤ì¼€ì¤„ ìº˜ë¦°ë”
        </h2>
        
        <!-- ì›” ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary" id="prevMonthBtn">
                        <i class="fas fa-chevron-left"></i> ì´ì „ ë‹¬
                    </button>
                    <h3 class="mb-0" id="calendarTitle"></h3>
                    <button type="button" class="btn btn-outline-secondary" id="nextMonthBtn">
                        ë‹¤ìŒ ë‹¬ <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ìº˜ë¦°ë” ê·¸ë¦¬ë“œ -->
        <div class="card">
            <div class="card-body p-0">
                <div id="calendar" class="calendar-grid"></div>
            </div>
        </div>
        
        <!-- ë²”ë¡€ -->
        <div class="mt-3 mb-4">
            <div class="d-flex gap-3 justify-content-center">
                <div><span class="badge" style="background-color: #28a745;">ë…¹ìƒ‰</span> = ë°œì†¡ ì „ (ì§„í–‰ ì¤‘)</div>
                <div><span class="badge" style="background-color: #6c757d;">íšŒìƒ‰</span> = ë°œì†¡ ì™„ë£Œ</div>
            </div>
        </div>
    </div>
    <!-- ìº˜ë¦°ë” ë·° ë -->
</div>

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì „ì—­)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì „ì²´ ì„ íƒ/í•´ì œ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateExportButton();
        });
    }

    // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateExportButton();
            updateSelectAll();
        });
    });

    function updateExportButton() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.disabled = checkedBoxes.length === 0;
        }
    }

    function updateSelectAll() {
        const allCheckboxes = document.querySelectorAll('.order-checkbox');
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allCheckboxes.length === checkedBoxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        }
    }
});

// ì—‘ì…€ ì¶œë ¥ í›„ ì™„ë£Œëœ ì£¼ë¬¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkedBoxes.length > 0) {
                // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í›„ ì™„ë£Œëœ ì£¼ë¬¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
                setTimeout(function() {
                    window.location.href = '{% url "order_list" %}?status=COMPLETED';
                }, 2000);
            }
        });
    }
});

// ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.status-change-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const orderId = this.getAttribute('data-order-id');
            const nextStatus = this.getAttribute('data-next-status');
            
            console.log('ìƒíƒœ ë³€ê²½ ë²„íŠ¼ í´ë¦­:', orderId, nextStatus);
            
            if (!orderId || !nextStatus) {
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // form ìƒì„± ë° ì œì¶œ
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "change_order_status" %}';
            
            // CSRF í† í°
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);
            
            // order_id
            const orderIdInput = document.createElement('input');
            orderIdInput.type = 'hidden';
            orderIdInput.name = 'order_id';
            orderIdInput.value = orderId;
            form.appendChild(orderIdInput);
            
            // next_status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'next_status';
            statusInput.value = nextStatus;
            form.appendChild(statusInput);
            
            // formì„ bodyì— ì¶”ê°€í•˜ê³  ì œì¶œ
            document.body.appendChild(form);
            form.submit();
        });
    });
});

// ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì´ˆê¸°í™” ì‹œì‘ ===');
    
    // ì‹œì•ˆ ì—…ë¡œë“œ ë²„íŠ¼ë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.upload-design-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨ ===');
            console.log('í´ë¦­ëœ ë²„íŠ¼:', this);
            
            const orderId = this.getAttribute('data-order-id');
            const customerName = this.getAttribute('data-customer-name');
            
            console.log('ì£¼ë¬¸ ID:', orderId);
            console.log('ê³ ê°ëª…:', customerName);
            
            if (!orderId || !customerName) {
                console.error('ì£¼ë¬¸ ID ë˜ëŠ” ê³ ê°ëª…ì´ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ í‘œì‹œ
            showUploadModal(orderId, customerName);
        });
    });
    
    // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function showUploadModal(orderId, customerName) {
        console.log('ëª¨ë‹¬ í‘œì‹œ ì‹œì‘');
        
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
        const existingModal = document.getElementById('uploadDesignModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHTML = `
            <div class="modal fade show" id="uploadDesignModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ì‹œì•ˆ ì—…ë¡œë“œ: ${customerName}</h5>
                            <button type="button" class="btn-close" onclick="closeUploadModal()"></button>
                        </div>
                        <form method="post" action="/orders/upload-design/" enctype="multipart/form-data">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customer_name_display" class="form-label">ê³ ê°ëª…</label>
                                    <input type="text" class="form-control" id="customer_name_display" value="${customerName}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="thumbnail_images" class="form-label">
                                        <i class="fas fa-images me-2"></i>ì¸ë„¤ì¼ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥) <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="thumbnail_images" name="thumbnail_images" multiple required accept="image/jpeg,image/png,image/jpg,image/gif,image/webp">
                                    <div class="form-text">
                                        ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¢Œìš°ë¡œ ë„˜ê²¨ë³¼ ìˆ˜ ìˆëŠ” ì¸ë„¤ì¼ (JPG, PNG, GIF, WEBP) - ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥
                                    </div>
                                    <div id="thumbnail-preview" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="design_files" class="form-label">
                                        <i class="fas fa-upload me-2"></i>ì‹œì•ˆ íŒŒì¼ (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)
                                    </label>
                                    <input type="file" class="form-control" id="design_files" name="design_files" multiple required accept="image/*,.pdf,.ai,.psd">
                                    <div class="form-text">
                                        <div class="alert alert-info py-2 px-3 mt-2 mb-0">
                                            <strong>ğŸ“ íŒŒì¼ ì„ íƒ ë°©ë²•:</strong><br>
                                            â€¢ <strong>Windows:</strong> Ctrl + í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ<br>
                                            â€¢ <strong>Mac:</strong> Cmd (âŒ˜) + í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ<br>
                                            â€¢ <strong>ë²”ìœ„ ì„ íƒ:</strong> Shift + í´ë¦­<br>
                                            <hr class="my-2">
                                            <strong>ğŸ“„ ì§€ì› í˜•ì‹:</strong> JPG, PNG, GIF, PDF, AI, PSD
                                        </div>
                                    </div>
                                    <div id="file-list" class="mt-2"></div>
                                </div>
                                <input type="hidden" name="order_id" value="${orderId}">
                                <!-- ì—…ë¡œë“œ ì§„í–‰ ì¤‘ í‘œì‹œ ì˜ì—­ -->
                                <div id="upload-progress" class="alert alert-warning" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-3" role="status">
                                            <span class="visually-hidden">ì—…ë¡œë“œ ì¤‘...</span>
                                        </div>
                                        <div>
                                            <strong>íŒŒì¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</strong><br>
                                            <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()" id="cancelBtn">ì·¨ì†Œ</button>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">
                                    <i class="fas fa-upload me-2"></i>ì—…ë¡œë“œ ë° ì»¨íŒ ì™„ë£Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.classList.add('modal-open');
        
        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª¨ë‹¬ì´ ì¶”ê°€ëœ í›„)
        setTimeout(() => {
            const fileInput = document.getElementById('design_files');
            const fileList = document.getElementById('file-list');
            const thumbnailInput = document.getElementById('thumbnail_image');
            const thumbnailPreview = document.getElementById('thumbnail-preview');
            const uploadForm = document.querySelector('#uploadDesignModal form');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì—¬ëŸ¬ ì¥)
            if (thumbnailInput && thumbnailPreview) {
                thumbnailInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        let html = `
                            <div class="alert alert-success py-2 px-3">
                                <strong>ì„ íƒëœ ì¸ë„¤ì¼ (${this.files.length}ì¥):</strong>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                        `;
                        
                        Array.from(this.files).forEach((file, idx) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgHtml = `
                                    <div class="text-center">
                                        <img src="${e.target.result}" alt="ì¸ë„¤ì¼ ${idx + 1}" style="max-width: 150px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                        <div class="small mt-1">${idx + 1}. ${file.name}</div>
                                    </div>
                                `;
                                thumbnailPreview.querySelector('.d-flex').insertAdjacentHTML('beforeend', imgHtml);
                            };
                            reader.readAsDataURL(file);
                        });
                        
                        html += '</div></div>';
                        thumbnailPreview.innerHTML = html;
                    } else {
                        thumbnailPreview.innerHTML = '';
                    }
                });
            }
            
            if (fileInput && fileList) {
                fileInput.addEventListener('change', function(e) {
                    if (this.files.length > 0) {
                        let html = '<div class="alert alert-success py-2 px-3"><strong>ì„ íƒëœ íŒŒì¼ (' + this.files.length + 'ê°œ):</strong><ul class="mb-0 mt-1">';
                        for (let i = 0; i < this.files.length; i++) {
                            const file = this.files[i];
                            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                            html += '<li>' + file.name + ' (' + sizeInMB + ' MB)</li>';
                        }
                        html += '</ul></div>';
                        fileList.innerHTML = html;
                    } else {
                        fileList.innerHTML = '';
                    }
                });
            }
            
            // form submit ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    // ë¡œë”© í‘œì‹œ
                    uploadProgress.style.display = 'block';
                    
                    // ë²„íŠ¼ ë¹„í™œì„±í™”
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>ì—…ë¡œë“œ ì¤‘...';
                    
                    // ì·¨ì†Œ ë²„íŠ¼ë„ ë¹„í™œì„±í™”
                    cancelBtn.disabled = true;
                    
                    // formì€ ì •ìƒì ìœ¼ë¡œ ì œì¶œë¨ (e.preventDefault() í•˜ì§€ ì•ŠìŒ)
                });
            }
        }, 100);
        
        console.log('ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
    }
    
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    window.closeUploadModal = function() {
        console.log('ëª¨ë‹¬ ë‹«ê¸°');
        const modal = document.getElementById('uploadDesignModal');
        if (modal) {
            modal.remove();
        }
        document.body.classList.remove('modal-open');
    };
    
    console.log('=== ì‹œì•ˆ ì—…ë¡œë“œ ëª¨ë‹¬ ì´ˆê¸°í™” ì™„ë£Œ ===');
});

// ì œí’ˆ ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const dropdownButtons = document.querySelectorAll('.product-dropdown-btn');
    
    dropdownButtons.forEach(button => {
        const orderId = button.getAttribute('data-order-id');
        const menu = document.getElementById('product-menu-' + orderId);
        const btnText = button.querySelector('.btn-text');
        const originalText = btnText.textContent;
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // ëª¨ë“  ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('.product-dropdown-menu').forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(b => {
                if (b !== button) {
                    b.classList.remove('active');
                    const otherText = b.querySelector('.btn-text');
                    const otherOriginal = otherText.getAttribute('data-original');
                    if (otherOriginal) {
                        otherText.textContent = otherOriginal;
                    }
                }
            });
            
            // í˜„ì¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                // ë‹«ê¸°
                menu.classList.remove('show');
                button.classList.remove('active');
                btnText.textContent = originalText;
            } else {
                // ì—´ê¸°
                menu.classList.add('show');
                button.classList.add('active');
                btnText.setAttribute('data-original', originalText);
                // ë²„íŠ¼ì€ ìˆ¨ê²¨ì§€ë¯€ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½ ë¶ˆí•„ìš”
            }
        });
    });
    
    // ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.product-dropdown-wrapper')) {
            document.querySelectorAll('.product-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            
            document.querySelectorAll('.product-dropdown-btn').forEach(button => {
                button.classList.remove('active');
                const btnText = button.querySelector('.btn-text');
                const originalText = btnText.getAttribute('data-original');
                if (originalText) {
                    btnText.textContent = originalText;
                }
            });
        }
    });
});

// ê²°ê³¼ ì…ë ¥ ëª¨ë‹¬ (ì£¼ë¬¸ ëª©ë¡ì—ì„œ)
document.addEventListener('click', function(e) {
    if (e.target.closest('.completion-input-btn-list')) {
        const btn = e.target.closest('.completion-input-btn-list');
        const orderId = btn.dataset.orderId;
        const customerName = btn.dataset.customerName;
        showCompletionModal(orderId, customerName);
    }
    
    // ì™„ë£Œì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬
    if (e.target.closest('.view-completion-btn')) {
        const btn = e.target.closest('.view-completion-btn');
        const orderId = btn.dataset.orderId;
        const customerName = btn.dataset.customerName;
        showViewCompletionModal(orderId, customerName);
    }
});

// ì™„ë£Œ ê²°ê³¼ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showCompletionModal(orderId, customerName) {
    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    const existingModal = document.getElementById('completionInputModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ëª¨ë‹¬ HTML ìƒì„±
    const modalHTML = `
        <div class="modal fade show" id="completionInputModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-clipboard-check"></i> ê²°ê³¼ ì…ë ¥: ${customerName}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeCompletionModal()"></button>
                    </div>
                    <form method="post" action="/orders/${orderId}/completion/" enctype="multipart/form-data">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="tracking_number" class="form-label">
                                    <i class="fas fa-truck"></i> ì†¡ì¥ë²ˆí˜¸
                                </label>
                                <input type="text" class="form-control" id="tracking_number" name="tracking_number" 
                                       placeholder="ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                <div class="form-text">
                                    íƒë°° ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="completion_photos" class="form-label">
                                    <i class="fas fa-images"></i> ì™„ë£Œì‚¬ì§„ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)
                                </label>
                                <input type="file" class="form-control" id="completion_photos" 
                                       name="completion_photos" multiple accept="image/*">
                                <div class="form-text">
                                    ì œì‘ ì™„ë£Œëœ ì œí’ˆì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. (JPG, PNG ë“±)
                                </div>
                                <div id="completion-photo-preview" class="mt-2"></div>
                            </div>
                            
                            <div class="alert alert-info small mb-0">
                                <i class="fas fa-info-circle"></i> 
                                ê²°ê³¼ ì…ë ¥ì´ ì™„ë£Œë˜ë©´ ìƒíƒœê°€ <strong>ì •ì‚° ëª©ë¡</strong>ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
                            </div>
                            
                            <!-- ì—…ë¡œë“œ ì§„í–‰ ì¤‘ í‘œì‹œ ì˜ì—­ -->
                            <div id="completion-upload-progress" class="alert alert-warning mt-3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-3" role="status">
                                        <span class="visually-hidden">ì—…ë¡œë“œ ì¤‘...</span>
                                    </div>
                                    <div>
                                        <strong>ê²°ê³¼ ì…ë ¥ ì¤‘ì…ë‹ˆë‹¤...</strong><br>
                                        <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeCompletionModal()" id="completionCancelBtn">ì·¨ì†Œ</button>
                            <button type="submit" class="btn btn-success" id="completionSubmitBtn">
                                <i class="fas fa-check-double"></i> ê²°ê³¼ ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
    
    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    setTimeout(() => {
        const photoInput = document.getElementById('completion_photos');
        const photoPreview = document.getElementById('completion-photo-preview');
        const completionForm = document.querySelector('#completionInputModal form');
        const uploadProgress = document.getElementById('completion-upload-progress');
        const submitBtn = document.getElementById('completionSubmitBtn');
        const cancelBtn = document.getElementById('completionCancelBtn');
        
        // ì™„ë£Œì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function(e) {
                if (this.files && this.files.length > 0) {
                    let html = `
                        <div class="alert alert-success py-2 px-3">
                            <i class="fas fa-check-circle"></i> 
                            <strong>${this.files.length}ì¥ì˜ ì‚¬ì§„</strong>ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.
                        </div>
                    `;
                    photoPreview.innerHTML = html;
                } else {
                    photoPreview.innerHTML = '';
                }
            });
        }
        
        // í¼ ì œì¶œ ì‹œ ì§„í–‰ í‘œì‹œ
        if (completionForm) {
            completionForm.addEventListener('submit', function(e) {
                uploadProgress.style.display = 'block';
                submitBtn.disabled = true;
                cancelBtn.disabled = true;
            });
        }
    }, 100);
}

// ì™„ë£Œ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
function closeCompletionModal() {
    const modal = document.getElementById('completionInputModal');
    if (modal) {
        modal.remove();
    }
    document.body.classList.remove('modal-open');
}

// ì™„ë£Œì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬
function showViewCompletionModal(orderId, customerName) {
    // AJAXë¡œ ì™„ë£Œì‚¬ì§„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch(`/orders/${orderId}/completion-info/`)
        .then(response => response.json())
        .then(data => {
            displayViewCompletionModal(data, customerName);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì™„ë£Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ì™„ë£Œì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
function displayViewCompletionModal(data, customerName) {
    const existingModal = document.getElementById('viewCompletionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ì™„ë£Œì‚¬ì§„ ì´ë¯¸ì§€ HTML ìƒì„±
    let photosHTML = '';
    if (data.completion_photos && data.completion_photos.length > 0) {
        data.completion_photos.forEach((photo, index) => {
            photosHTML += `
                <div class="carousel-item ${index === 0 ? 'active' : ''}" style="text-align: center; position: relative;">
                    <img src="${photo.image_url}" alt="ì™„ë£Œì‚¬ì§„ ${index + 1}" style="max-width: 100%; max-height: 500px; object-fit: contain;">
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-primary" onclick="copyImageToClipboard('${photo.image_url}', event)">
                            <i class="fas fa-copy"></i> ì´ë¯¸ì§€ ë³µì‚¬
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        photosHTML = '<div class="alert alert-info">ì™„ë£Œì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    
    // ì†¡ì¥ë²ˆí˜¸ HTML
    const trackingHTML = data.tracking_number ? `
        <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" id="trackingNumberCopy" value="${data.tracking_number}" readonly>
            <button type="button" class="btn btn-primary" onclick="copyTrackingNumber()">
                <i class="fas fa-copy"></i> ë³µì‚¬
            </button>
        </div>
    ` : '<span class="text-muted">ì†¡ì¥ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>';
    
    const modalHTML = `
        <div class="modal fade show" id="viewCompletionModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="fas fa-eye"></i> ê²°ê³¼ ë³´ê¸°: ${customerName}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeViewCompletionModal()"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ì™„ë£Œì‚¬ì§„ -->
                        <div class="mb-4">
                            <h6 class="mb-3"><i class="fas fa-images"></i> ì™„ë£Œì‚¬ì§„</h6>
                            ${data.completion_photos && data.completion_photos.length > 0 ? `
                                <div id="completionPhotoCarousel" class="carousel slide" data-bs-ride="false" style="position: relative;">
                                    <div class="carousel-inner">
                                        ${photosHTML}
                                    </div>
                                    ${data.completion_photos.length > 1 ? `
                                        <button class="carousel-control-prev" type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide="prev" style="position: absolute; top: 50%; transform: translateY(-50%); left: 10px; background-color: rgba(0,0,0,0.5); border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; z-index: 10;">
                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide="next" style="position: absolute; top: 50%; transform: translateY(-50%); right: 10px; background-color: rgba(0,0,0,0.5); border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; z-index: 10;">
                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        </button>
                                        <div class="carousel-indicators" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10;">
                                            ${data.completion_photos.map((_, index) => `
                                                <button type="button" data-bs-target="#completionPhotoCarousel" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}" style="background-color: ${index === 0 ? '#0dcaf0' : 'rgba(255,255,255,0.5)'}; padding: 8px 12px; border-radius: 20px; border: none; min-width: 35px; cursor: pointer;"></button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : photosHTML}
                        </div>
                        
                        <hr>
                        
                        <!-- ì†¡ì¥ë²ˆí˜¸ -->
                        <div class="mb-3">
                            <h6 class="mb-3"><i class="fas fa-truck"></i> ì†¡ì¥ë²ˆí˜¸</h6>
                            ${trackingHTML}
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="closeViewCompletionModal()">ë‹«ê¸°</button>
                        <form action="/orders/${data.order_id}/archive/" method="post" id="archiveForm${data.order_id}" onsubmit="return handleArchiveSubmit(event);">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-arrow-right me-1"></i> ë„˜ê¸°ê¸°
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.body.classList.add('modal-open');
    
    // Bootstrap ìºëŸ¬ì…€ ì´ˆê¸°í™”
    if (data.completion_photos && data.completion_photos.length > 1) {
        const carouselElement = document.getElementById('completionPhotoCarousel');
        if (carouselElement && window.bootstrap) {
            new bootstrap.Carousel(carouselElement);
        }
    }
}

// ì™„ë£Œì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
function closeViewCompletionModal() {
    const modal = document.getElementById('viewCompletionModal');
    if (modal) {
        modal.remove();
    }
    document.body.classList.remove('modal-open');
}

// ì†¡ì¥ë²ˆí˜¸ ë³µì‚¬
function copyTrackingNumber() {
    const input = document.getElementById('trackingNumberCopy');
    input.select();
    document.execCommand('copy');
    
    // ë³µì‚¬ ì™„ë£Œ í‘œì‹œ
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ë¨';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}

// ì´ë¯¸ì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
async function copyImageToClipboard(imageUrl, event) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    
    try {
        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ë¡œë”©)
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ë³µì‚¬ ì¤‘...';
        
        // Canvasë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¡œë“œ
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
        await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = imageUrl;
        });
        
        // Canvasì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // í´ë¦½ë³´ë“œì— ë³µì‚¬
        await navigator.clipboard.write([
            new ClipboardItem({
                'image/png': blob
            })
        ]);
        
        // ë³µì‚¬ ì„±ê³µ í‘œì‹œ
        btn.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ ì™„ë£Œ!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('ì´ë¯¸ì§€ ë³µì‚¬ ì‹¤íŒ¨:', error);
        
        // ë³µì‚¬ ì‹¤íŒ¨ í‘œì‹œ
        btn.innerHTML = '<i class="fas fa-times"></i> ë³µì‚¬ ì‹¤íŒ¨';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
            btn.disabled = false;
        }, 2000);
    }
}

// ì´ë¯¸ì§€ ì „ì²´í™”ë©´ ëª¨ë‹¬
function openImageModal(imageUrl) {
    const existingModal = document.getElementById('imageFullscreenModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="imageFullscreenModal" style="position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center;" onclick="closeImageModal()">
            <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 50px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeImageModal() {
    const modal = document.getElementById('imageFullscreenModal');
    if (modal) {
        modal.remove();
    }
}

// ë„˜ê¸°ê¸° í¼ ì œì¶œ ì²˜ë¦¬
function handleArchiveSubmit(event) {
    if (!confirm('ì´ ì£¼ë¬¸ì„ ì¢…ë£Œ ëª©ë¡ìœ¼ë¡œ ë„˜ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        event.preventDefault();
        return false;
    }
    
    // í¼ ì œì¶œ í›„ ëª¨ë‹¬ ë‹«ê³  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    const form = event.target;
    
    // AJAXë¡œ ì œì¶œ
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            // ëª¨ë‹¬ ë‹«ê¸°
            closeViewCompletionModal();
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
        } else {
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
    
    event.preventDefault();
    return false;
}

// ==================== ìº˜ë¦°ë” ê¸°ëŠ¥ ====================
let currentYear = {{ current_year }};
let currentMonth = {{ current_month }};
let calendarOrders = {{ calendar_orders_json|safe }};

// ì›” ë„¤ë¹„ê²Œì´ì…˜
document.getElementById('prevMonthBtn').addEventListener('click', function() {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    loadCalendarData();
});

document.getElementById('nextMonthBtn').addEventListener('click', function() {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    loadCalendarData();
});

// ìº˜ë¦°ë” ë°ì´í„° ë¡œë“œ (AJAX)
function loadCalendarData() {
    fetch(`/orders/?year=${currentYear}&month=${currentMonth}`)
        .then(response => response.text())
        .then(html => {
            // ê°„ë‹¨í•˜ê²Œ í˜ì´ì§€ ë¦¬ë¡œë“œ (ë” ë‚˜ì€ ë°©ë²•ì€ JSON API)
            window.location.href = `/orders/?year=${currentYear}&month=${currentMonth}`;
        });
}

// ìº˜ë¦°ë” ë Œë”ë§
function renderCalendar() {
    const calendar = document.getElementById('calendar');
    const title = document.getElementById('calendarTitle');
    
    title.textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
    
    // ìº˜ë¦°ë” ì´ˆê¸°í™”
    calendar.innerHTML = '';
    
    // ìš”ì¼ í—¤ë”
    const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    weekDays.forEach((day, index) => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        if (index === 0) header.classList.add('sunday');
        if (index === 6) header.classList.add('saturday');
        header.textContent = day;
        calendar.appendChild(header);
    });
    
    // í•´ë‹¹ ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
    const firstDay = new Date(currentYear, currentMonth - 1, 1);
    const lastDay = new Date(currentYear, currentMonth, 0);
    const daysInMonth = lastDay.getDate();
    const firstDayOfWeek = firstDay.getDay();
    
    // ì´ì „ ë‹¬ ë‚ ì§œë“¤
    const prevMonthLastDay = new Date(currentYear, currentMonth - 1, 0).getDate();
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const dayEl = createDayElement(day, true, null);
        calendar.appendChild(dayEl);
    }
    
    // í˜„ì¬ ë‹¬ ë‚ ì§œë“¤
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth - 1, day);
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // í•´ë‹¹ ë‚ ì§œì˜ ì£¼ë¬¸ë“¤ ì°¾ê¸°
        const dayOrders = calendarOrders.filter(order => order.due_date === dateStr);
        
        const isToday = date.getFullYear() === today.getFullYear() && 
                        date.getMonth() === today.getMonth() && 
                        date.getDate() === today.getDate();
        
        const dayEl = createDayElement(day, false, dayOrders, isToday);
        calendar.appendChild(dayEl);
    }
    
    // ë‹¤ìŒ ë‹¬ ë‚ ì§œë“¤ (6ì£¼ ì±„ìš°ê¸°)
    const totalCells = calendar.children.length - 7; // í—¤ë” ì œì™¸
    const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        const dayEl = createDayElement(day, true, null);
        calendar.appendChild(dayEl);
    }
}

// ë‚ ì§œ ìš”ì†Œ ìƒì„±
function createDayElement(day, isOtherMonth, orders, isToday = false) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    if (isOtherMonth) dayEl.classList.add('other-month');
    if (isToday) dayEl.classList.add('today');
    
    // ë‚ ì§œ í—¤ë”
    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    header.textContent = day;
    dayEl.appendChild(header);
    
    // ì£¼ë¬¸ ëª©ë¡
    if (orders && orders.length > 0) {
        orders.forEach(order => {
            const orderEl = document.createElement('div');
            orderEl.className = `calendar-order-item ${order.is_shipped ? 'shipped' : 'pending'}`;
            orderEl.textContent = `${order.customer_name} (${order.items_count}ê°œ)`;
            orderEl.title = `${order.order_id} - ${order.status_display}`;
            orderEl.onclick = () => window.location.href = `/orders/${order.id}/`;
            dayEl.appendChild(orderEl);
        });
    }
    
    return dayEl;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìº˜ë¦°ë” ë Œë”ë§
document.addEventListener('DOMContentLoaded', function() {
    renderCalendar();
});
</script>
{% endblock %}
